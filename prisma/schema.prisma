generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String    @id @default(uuid()) @db.Uuid
  username          String    @unique
  displayName       String    @map("display_name")
  passwordHash      String    @map("password_hash")
  role              String    // 'admin' | 'user'
  disabled          Boolean   @default(false)
  mustChangePassword Boolean  @default(true) @map("must_change_password")
  createdAt         DateTime  @default(now()) @map("created_at")
  updatedAt         DateTime  @updatedAt @map("updated_at")

  sessions       Session[]
  auditLogAsActor AuditLog[] @relation("ActorUser")
  auditLogAsTarget AuditLog[] @relation("TargetUser")
  authEvents     AuthEvent[]
  chatMessages   ChatMessage[]

  streamStateAsActive StreamState? @relation("ActiveStreamer")
  calendarIntegration UserCalendarIntegration?

  @@map("users")
}

model Session {
  id         String   @id @default(uuid()) @db.Uuid
  userId     String   @map("user_id") @db.Uuid
  tokenHash  String   @unique @map("token_hash")
  createdAt  DateTime @default(now()) @map("created_at")
  expiresAt  DateTime @map("expires_at")
  lastSeenAt DateTime @default(now()) @map("last_seen_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model StreamState {
  id                         Int       @id // always 1
  activeStreamerUserId       String?   @unique @map("active_streamer_user_id") @db.Uuid
  isLive                     Boolean   @default(false) @map("is_live")
  liveStartedAt              DateTime? @map("live_started_at")
  lastHeartbeatAt            DateTime? @map("last_heartbeat_at")
  pendingRequestFromUserId   String?   @map("pending_request_from_user_id") @db.Uuid
  pendingRequestAt           DateTime? @map("pending_request_at")
  updatedAt                  DateTime  @updatedAt @map("updated_at")

  activeStreamer User?  @relation("ActiveStreamer", fields: [activeStreamerUserId], references: [id], onDelete: SetNull)
  telemetryLatest TelemetryLatest?

  @@map("stream_state")
}

model TelemetryLatest {
  streamStateId Int     @id @map("stream_state_id")
  lat           Float?
  lon           Float?
  headingDeg    Float?  @map("heading_deg")
  accuracyM     Float?  @map("accuracy_m")
  updatedAt     DateTime @updatedAt @map("updated_at")

  streamState StreamState @relation(fields: [streamStateId], references: [id], onDelete: Cascade)

  @@map("telemetry_latest")
}

model AuditLog {
  id           String   @id @default(uuid()) @db.Uuid
  actorUserId  String   @map("actor_user_id") @db.Uuid
  action       String
  targetUserId String?  @map("target_user_id") @db.Uuid
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at")

  actor  User  @relation("ActorUser", fields: [actorUserId], references: [id], onDelete: Cascade)
  target User? @relation("TargetUser", fields: [targetUserId], references: [id], onDelete: SetNull)

  @@map("audit_log")
}

model AuthEvent {
  id               String   @id @default(uuid()) @db.Uuid
  userId           String?  @map("user_id") @db.Uuid
  usernameAttempted String? @map("username_attempted")
  eventType        String   @map("event_type") // 'login_success' | 'login_failed' | 'logout'
  ip               String?
  userAgent        String?  @map("user_agent")
  createdAt        DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("auth_events")
}

model ChatMessage {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  text      String
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}

model UserCalendarIntegration {
  id           String    @id @default(uuid()) @db.Uuid
  userId       String    @unique @map("user_id") @db.Uuid
  provider     String    @default("google")
  calendarId   String    @default("primary") @map("calendar_id")
  accessToken  String?   @map("access_token")
  refreshToken String?   @map("refresh_token")
  scope        String?
  expiryDate   BigInt?   @map("expiry_date") // ms epoch
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_calendar_integrations")
}
