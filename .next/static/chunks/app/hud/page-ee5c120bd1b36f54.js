(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[100],{6504:(e,t,a)=>{Promise.resolve().then(a.bind(a,4916))},4916:(e,t,a)=>{"use strict";a.d(t,{default:()=>E});var r=a(5155),s=a(2115),n=a(7396),l=a(7648),i=a(4563);let c=i.Ik({type:i.eu("chat"),messageId:i.Yj(),userId:i.Yj(),username:i.Yj(),text:i.Yj(),ts:i.Yj()}),o=i.Ik({type:i.eu("stream:status"),activeStreamerUserId:i.Yj().nullable(),isLive:i.zM(),liveStartedAt:i.Yj().nullable(),ts:i.ai()}),u=i.Ik({type:i.eu("stream:request"),fromUserId:i.Yj(),fromUsername:i.Yj(),ts:i.ai()}),d=i.Ik({type:i.eu("stream:request:response"),accepted:i.zM(),toUserId:i.Yj(),ts:i.ai()}),m=i.Ik({type:i.eu("stream:handoff"),newStreamerUserId:i.Yj(),ts:i.ai()}),h=i.gM("type",[c,o,u,d,m]),f=new TextEncoder,p=new TextDecoder;function v(e){return f.encode(JSON.stringify(e))}function x(e){try{let t=JSON.parse(p.decode(e));return h.parse(t)}catch(e){return null}}function b(e){let{isStreamer:t,userId:a,displayName:n,room:i,onRoomReady:c,onDataReceived:o,onLiveKitConfig:u}=e,d=(0,s.useRef)(null),m=(0,s.useRef)(null),[h,f]=(0,s.useState)(!1),[p,b]=(0,s.useState)(!1),g=(0,s.useRef)(null),y=(0,s.useRef)(null),w=(0,s.useRef)(!1);w.current=h;let j=(0,s.useRef)(()=>Promise.resolve());(0,s.useEffect)(()=>{let e=!1,r=null;return async function(){let s=await fetch("/api/livekit/token/viewer",{method:"POST"}),i=await s.json();if(503===s.status||!i.token){u(!1);return}u(!0),r=new l.Wv,m.current=r,r.on(l.u9.TrackSubscribed,t=>{!e&&d.current&&t.kind===l.CC.Kind.Video&&t.attach(d.current)}),r.on(l.u9.TrackUnsubscribed,()=>{d.current&&(d.current.srcObject=null)}),await r.connect(i.url,i.token),r.localParticipant.setMetadata(JSON.stringify({userId:a,displayName:n})),e||(b(t),c(r))}(),()=>{e=!0,r&&(r.disconnect(),m.current=null)}},[a,n,u]),(0,s.useEffect)(()=>{b(t)},[t]),(0,s.useEffect)(()=>{if(!i)return;let e=e=>{let t=x(e);t&&(o(t),"stream:handoff"===t.type&&t.newStreamerUserId!==a&&w.current&&j.current())};return i.on(l.u9.DataReceived,e),()=>{i.off(l.u9.DataReceived,e)}},[i,a,o]),(0,s.useEffect)(()=>{if(!t)return;let e=setInterval(()=>{fetch("/api/stream/heartbeat",{method:"POST"}).catch(()=>{})},2e3);return g.current=e,()=>{g.current&&clearInterval(g.current)}},[t]),(0,s.useEffect)(()=>{if(t&&h){if(window.DeviceOrientationEvent){let e=e=>{null!=e.alpha&&(window._lastHeading=e.alpha)};return window.addEventListener("deviceorientation",e),()=>window.removeEventListener("deviceorientation",e)}return()=>{}}},[t,h]),(0,s.useEffect)(()=>{if(!t||!h)return;let e=setInterval(()=>{navigator.geolocation&&navigator.geolocation.getCurrentPosition(e=>{var t;let a=e.coords.latitude,r=e.coords.longitude,s=null!==(t=e.coords.accuracy)&&void 0!==t?t:void 0;fetch("/api/telemetry/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({lat:a,lon:r,headingDeg:window._lastHeading,accuracyM:s})}).catch(()=>{})},()=>{},{enableHighAccuracy:!0})},1500);return y.current=e,()=>{y.current&&clearInterval(y.current)}},[t,h]);let S=async()=>{let e=m.current;if(!e)return;let t=await fetch("/api/livekit/token/streamer",{method:"POST"}),r=await t.json();if(!t.ok||!r.token){alert("Cannot get streamer token. Are you the active streamer?");return}await e.disconnect();let s=new l.Wv;m.current=s,await s.connect(r.url,r.token);let n=await navigator.mediaDevices.getUserMedia({video:!0,audio:!1}),i=new l.M0(n.getVideoTracks()[0]);await s.localParticipant.publishTrack(i,{simulcast:!1}),await fetch("/api/stream/set-live",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({isLive:!0})}),f(!0),d.current&&i.attach(d.current),c(s);let o={type:"stream:status",activeStreamerUserId:a,isLive:!0,liveStartedAt:new Date().toISOString(),ts:Date.now()};s.localParticipant.publishData(v(o),{reliable:!0}).catch(()=>{})},I=async()=>{let e=m.current;if(!e)return;let t={type:"stream:status",activeStreamerUserId:a,isLive:!1,liveStartedAt:null,ts:Date.now()};e.localParticipant.publishData(v(t),{reliable:!0}).catch(()=>{}),e.localParticipant.trackPublications.forEach(e=>{var t;null===(t=e.track)||void 0===t||t.stop()}),await e.disconnect(),await fetch("/api/stream/set-live",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({isLive:!1})}),f(!1),d.current&&(d.current.srcObject=null);let r=await fetch("/api/livekit/token/viewer",{method:"POST"}),s=await r.json();if(s.token&&d.current){let e=new l.Wv;m.current=e,e.on(l.u9.TrackSubscribed,e=>{e.kind===l.CC.Kind.Video&&e.attach(d.current)}),await e.connect(s.url,s.token),c(e)}};return j.current=I,(0,r.jsxs)("div",{className:"absolute inset-0 bg-black",children:[(0,r.jsx)("video",{ref:d,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover"}),p&&(0,r.jsx)("div",{className:"absolute bottom-20 left-1/2 -translate-x-1/2 flex gap-2 z-20",children:h?(0,r.jsx)("button",{type:"button",onClick:I,className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Stop"}):(0,r.jsx)("button",{type:"button",onClick:S,className:"px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700",children:"Go Live"})})]})}let g=["N","NE","E","SE","S","SW","W","NW"];function y(){let[e,t]=(0,s.useState)(null);return((0,s.useEffect)(()=>{let e=setInterval(()=>{fetch("/api/telemetry/latest").then(e=>e.json()).then(e=>{null!=e.headingDeg&&t(e.headingDeg)}).catch(()=>{})},1e3);return()=>clearInterval(e)},[]),null==e)?(0,r.jsx)("div",{className:"bg-black/60 text-white rounded-lg px-4 py-2 text-center text-sm",children:"Compass — no data"}):(0,r.jsxs)("div",{className:"bg-black/60 text-white rounded-lg px-4 py-2 text-center",children:[(0,r.jsxs)("div",{className:"text-2xl font-mono",children:[Math.round(e),"\xb0"]}),(0,r.jsx)("div",{className:"text-sm",children:g[Math.round((e%360+360)%360/45)%8]})]})}function w(){let[e,t]=(0,s.useState)([]);return(0,s.useEffect)(()=>{fetch("/api/widgets/calendar").then(e=>e.json()).then(e=>t(e.events||[])).catch(()=>{})},[]),(0,r.jsxs)("div",{className:"bg-black/60 text-white rounded-lg p-3 text-sm",children:[(0,r.jsx)("div",{className:"font-medium mb-2",children:"Calendar"}),(0,r.jsxs)("ul",{className:"space-y-1",children:[e.slice(0,5).map(e=>(0,r.jsxs)("li",{className:"truncate",children:[e.title," — ",new Date(e.start).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})]},e.id)),0===e.length&&(0,r.jsx)("li",{className:"text-gray-400",children:"No events"})]})]})}function j(){let[e,t]=(0,s.useState)(new Date().toISOString()),[a,n]=(0,s.useState)(null),[l,i]=(0,s.useState)(null),[c,o]=(0,s.useState)(null),[u,d]=(0,s.useState)(null);return(0,s.useEffect)(()=>{let e=setInterval(()=>t(new Date().toISOString()),1e3);return()=>clearInterval(e)},[]),(0,s.useEffect)(()=>{fetch("/api/telemetry/latest").then(e=>e.json()).then(e=>{null!=e.lat&&null!=e.lon&&(o(e.lat),d(e.lon))}).catch(()=>{})},[]),(0,s.useEffect)(()=>{null!=c&&null!=u&&(fetch("/api/widgets/reverse-geocode?lat="+c+"&lon="+u).then(e=>e.json()).then(e=>{n([e.city,e.state,e.country].filter(Boolean).join(", ")||null)}).catch(()=>{}),fetch("/api/widgets/weather?lat="+c+"&lon="+u).then(e=>e.json()).then(e=>i(null!=e.tempF?e.tempF+" \xb0F":null)).catch(()=>{}))},[c,u]),(0,r.jsxs)("div",{className:"bg-black/60 text-white rounded-lg p-3 text-sm",children:[(0,r.jsx)("div",{className:"font-mono",children:new Date(e).toLocaleTimeString()}),a&&(0,r.jsx)("div",{className:"text-gray-300 truncate",children:a}),l&&(0,r.jsx)("div",{children:l}),!a&&!l&&null==c&&(0,r.jsx)("div",{className:"text-gray-400",children:"—"})]})}var S=a(2818);let I="string"==typeof S.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY&&S.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY.length>0;function N(){let[e,t]=(0,s.useState)(null),[a,n]=(0,s.useState)(null);if((0,s.useEffect)(()=>{let e=setInterval(()=>{fetch("/api/telemetry/latest").then(e=>e.json()).then(e=>{null!=e.lat&&null!=e.lon&&(t(e.lat),n(e.lon))}).catch(()=>{})},2e3);return()=>clearInterval(e)},[]),!I)return(0,r.jsx)("div",{className:"bg-black/60 text-white rounded-lg p-3 h-full flex items-center justify-center text-sm",children:"Map placeholder (set GOOGLE_MAPS_API_KEY)"});if(null==e||null==a)return(0,r.jsx)("div",{className:"bg-black/60 text-white rounded-lg p-3 h-full flex items-center justify-center text-sm",children:"Waiting for location…"});let l="https://www.google.com/maps/embed/v1/view?key=".concat(S.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY,"&center=").concat(e,",").concat(a,"&zoom=15");return(0,r.jsx)("div",{className:"bg-black/60 rounded-lg overflow-hidden h-full w-full",children:(0,r.jsx)("iframe",{title:"Map",src:l,width:"100%",height:"100%",style:{border:0},allowFullScreen:!0,loading:"lazy"})})}function k(e){let{room:t,user:a}=e,[n,i]=(0,s.useState)([]),[c,o]=(0,s.useState)(""),[u,d]=(0,s.useState)(!1),m=(0,s.useRef)(null),h=(0,s.useRef)(0),f=(0,s.useRef)(0);function p(){var e,r,s;let n=c.trim();if(!n||!t)return;let l=Date.now();if(l-h.current>=1e3&&(f.current=0),f.current+=1,f.current>5)return;h.current=l;let u={type:"chat",messageId:null!==(s=null===(e=(r=crypto).randomUUID)||void 0===e?void 0:e.call(r))&&void 0!==s?s:Math.random().toString(36).slice(2),userId:a.id,username:a.displayName,text:n,ts:new Date().toISOString()},d=v(u);t.localParticipant.publishData(d,{reliable:!0}).catch(()=>{}),i(e=>[...e.slice(-99),{messageId:u.messageId,userId:u.userId,username:u.username,text:u.text,ts:u.ts}]),o("")}return(0,s.useEffect)(()=>{if(!t)return;let e=e=>{let t=x(e);(null==t?void 0:t.type)==="chat"&&i(e=>[...e.slice(-99),{messageId:t.messageId,userId:t.userId,username:t.username,text:t.text,ts:t.ts}])};return t.on(l.u9.DataReceived,e),()=>{t.off(l.u9.DataReceived,e)}},[t]),(0,s.useEffect)(()=>{var e;null===(e=m.current)||void 0===e||e.scrollIntoView({behavior:"smooth"})},[n]),(0,r.jsxs)("div",{className:"bg-black/60 text-white rounded-lg overflow-hidden flex flex-col max-h-64",children:[(0,r.jsxs)("button",{type:"button",onClick:()=>d(!u),className:"p-2 text-left font-medium text-sm flex justify-between",children:["Chat",(0,r.jsx)("span",{children:u?"▼":"▲"})]}),!u&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("div",{className:"overflow-y-auto flex-1 p-2 space-y-1 min-h-32 max-h-48",children:[n.map(e=>(0,r.jsxs)("div",{className:"text-sm",children:[(0,r.jsxs)("span",{className:"text-gray-400",children:[e.username,":"]})," ",e.text]},e.messageId)),(0,r.jsx)("div",{ref:m})]}),(0,r.jsxs)("div",{className:"p-2 flex gap-2 border-t border-white/20",children:[(0,r.jsx)("input",{type:"text",value:c,onChange:e=>o(e.target.value),onKeyDown:e=>"Enter"===e.key&&p(),placeholder:"Message…",className:"flex-1 bg-white/10 rounded px-2 py-1 text-sm"}),(0,r.jsx)("button",{type:"button",onClick:p,className:"px-2 py-1 bg-blue-600 rounded text-sm hover:bg-blue-700",children:"Send"})]})]})]})}function E(e){let{user:t}=e,[a,l]=(0,s.useState)({activeStreamerUserId:null,isLive:!1,startedAt:null}),[i,c]=(0,s.useState)(null),o=(0,s.useRef)(null);o.current=i;let[u,d]=(0,s.useState)(!1),[m,h]=(0,s.useState)(!1),[f,p]=(0,s.useState)(null),[x,g]=(0,s.useState)(null),S=a.activeStreamerUserId===t.id,I=(0,s.useRef)(a);I.current=a;let E=(0,s.useCallback)(e=>{let t=o.current;if(!t)return;let a=v(e);t.localParticipant.publishData(a,{reliable:!0}).catch(()=>{})},[]);(0,s.useEffect)(()=>{function e(){fetch("/api/stream/state").then(e=>e.json()).then(e=>{if(!e.error){var t,a,r;l({activeStreamerUserId:null!==(t=e.activeStreamerUserId)&&void 0!==t?t:null,isLive:null!==(a=e.isLive)&&void 0!==a&&a,startedAt:null!==(r=e.liveStartedAt)&&void 0!==r?r:null})}}).catch(()=>{})}e();let t=setInterval(e,5e3);return()=>clearInterval(t)},[]);let U=(0,s.useCallback)(e=>{"stream:status"===e.type?l({activeStreamerUserId:e.activeStreamerUserId,isLive:e.isLive,startedAt:e.liveStartedAt}):"stream:request"===e.type?(I.current.activeStreamerUserId===t.id||"admin"===t.role)&&p({fromUserId:e.fromUserId,fromUsername:e.fromUsername,ts:e.ts}):"stream:handoff"===e.type?p(null):"stream:request:response"===e.type&&p(null)},[t.id,t.role]),C=(0,s.useCallback)(async()=>{d(!0);try{let e=await fetch("/api/stream/adopt",{method:"POST"}),a=await e.json();if(!e.ok)throw Error(a.error||"Failed");l(e=>({...e,activeStreamerUserId:t.id,isLive:!1,startedAt:null}));let r={type:"stream:status",activeStreamerUserId:t.id,isLive:!1,liveStartedAt:null,ts:Date.now()};E(r)}catch(e){alert(e.message)}finally{d(!1)}},[t.id,E]),O=(0,s.useCallback)(async()=>{h(!0);try{let e=await fetch("/api/stream/request",{method:"POST"}),a=await e.json();if(!e.ok)throw Error(a.error||"Failed");let r={type:"stream:request",fromUserId:t.id,fromUsername:t.displayName,ts:Date.now()};E(r),alert("Request sent. Waiting for streamer to respond.")}catch(e){alert(e.message)}finally{h(!1)}},[t.id,t.displayName,E]),P=(0,s.useCallback)(async(e,t)=>{try{if(!(await fetch("/api/stream/respond",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accepted:e,toUserId:t})})).ok)throw Error("Failed");p(null);let a=Date.now();e&&(E({type:"stream:handoff",newStreamerUserId:t,ts:a}),E({type:"stream:status",activeStreamerUserId:t,isLive:!1,liveStartedAt:null,ts:a})),E({type:"stream:request:response",accepted:e,toUserId:t,ts:a})}catch(e){alert("Failed to respond")}},[E]),D=(0,s.useCallback)(async()=>{try{await fetch("/api/stream/release",{method:"POST"}),E({type:"stream:status",activeStreamerUserId:null,isLive:!1,liveStartedAt:null,ts:Date.now()})}catch(e){alert("Failed to release")}},[E]);return(0,r.jsxs)("div",{className:"fixed inset-0 bg-black overflow-hidden",children:[(0,r.jsx)(b,{isStreamer:S,userId:t.id,displayName:t.displayName,room:i,onRoomReady:c,onDataReceived:U,onLiveKitConfig:e=>g(e)}),!a.activeStreamerUserId&&(0,r.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-black/70 z-10",children:(0,r.jsxs)("div",{className:"text-center text-white p-6",children:[(0,r.jsx)("p",{className:"text-xl mb-4",children:"No Live Stream — Adopt Stream Identity"}),(0,r.jsx)("button",{type:"button",onClick:C,disabled:u,className:"px-6 py-3 bg-blue-600 rounded hover:bg-blue-700 disabled:opacity-50",children:u?"Adopting…":"Adopt Stream Identity"})]})}),!1===x&&(0,r.jsx)("div",{className:"absolute top-4 left-1/2 -translate-x-1/2 z-20 bg-amber-600 text-white px-4 py-2 rounded text-sm",children:"Streaming not configured (set LIVEKIT_* env vars)"}),(0,r.jsx)("div",{className:"absolute top-4 left-4 z-20 w-48",children:(0,r.jsx)(w,{})}),(0,r.jsx)("div",{className:"absolute top-4 left-1/2 -translate-x-1/2 z-20",children:(0,r.jsx)(y,{})}),(0,r.jsx)("div",{className:"absolute top-4 right-4 z-20 w-48",children:(0,r.jsx)(j,{})}),(0,r.jsx)("div",{className:"absolute bottom-4 right-4 z-20 w-64 h-48",children:(0,r.jsx)(N,{})}),(0,r.jsx)("div",{className:"absolute bottom-4 left-4 z-20 w-80 max-h-64",children:(0,r.jsx)(k,{room:i,user:t})}),(0,r.jsxs)("div",{className:"absolute bottom-4 left-1/2 -translate-x-1/2 z-20 flex gap-2",children:[a.activeStreamerUserId&&!S&&(0,r.jsx)("button",{type:"button",onClick:O,disabled:m,className:"px-4 py-2 bg-gray-700 text-white rounded hover:bg-gray-600 disabled:opacity-50",children:m?"Requesting…":"Request to Stream"}),S&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.default,{href:"/admin",className:"px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-500",children:"Admin"}),(0,r.jsx)("button",{type:"button",onClick:D,className:"px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700",children:"Release streamer"})]})]}),f&&(S||"admin"===t.role)&&(0,r.jsx)("div",{className:"absolute inset-0 bg-black/60 flex items-center justify-center z-30",children:(0,r.jsxs)("div",{className:"bg-white rounded-lg p-6 max-w-sm w-full mx-4",children:[(0,r.jsxs)("p",{className:"font-medium mb-2",children:[f.fromUsername," wants to become the streamer."]}),(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("button",{type:"button",onClick:()=>P(!1,f.fromUserId),className:"flex-1 py-2 border rounded hover:bg-gray-100",children:"Decline"}),(0,r.jsx)("button",{type:"button",onClick:()=>P(!0,f.fromUserId),className:"flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-700",children:"Accept"})]})]})})]})}}},e=>{var t=t=>e(e.s=t);e.O(0,[501,839,802,441,517,358],()=>t(6504)),_N_E=e.O()}]);