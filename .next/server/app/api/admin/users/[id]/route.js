(()=>{var e={};e.id=452,e.ids=[452],e.modules={6330:e=>{"use strict";e.exports=require("@prisma/client")},846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},5511:e=>{"use strict";e.exports=require("crypto")},7598:e=>{"use strict";e.exports=require("node:crypto")},3577:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>v,routeModule:()=>f,serverHooks:()=>g,workAsyncStorage:()=>y,workUnitAsyncStorage:()=>U});var a={};r.r(a),r.d(a,{DELETE:()=>x,PATCH:()=>h});var s=r(2706),n=r(8203),i=r(5994),o=r(9187),d=r(7727),u=r(5665),l=r(7702),c=r(7914),p=r(6309),w=r(6702);let m=d.Ik({displayName:d.Yj().min(1).max(200).optional(),role:d.k5(["admin","user"]).optional(),disabled:d.zM().optional()});async function h(e,{params:t}){let r;try{r=await (0,l.ZT)()}catch(e){return o.NextResponse.json({error:"Forbidden"},{status:e.statusCode??403})}let{id:a}=await t;try{let t=await e.json(),s=m.parse(t),n=await c.z.user.findUnique({where:{id:a}});if(!n)return o.NextResponse.json({error:"User not found"},{status:404});if(!0===s.disabled&&n.id===r.id)return o.NextResponse.json({error:"Cannot disable your own account"},{status:400});let i=await c.z.user.update({where:{id:a},data:{...void 0!==s.displayName&&{displayName:s.displayName},...void 0!==s.role&&{role:s.role},...void 0!==s.disabled&&{disabled:s.disabled}},select:{id:!0,username:!0,displayName:!0,role:!0,disabled:!0,mustChangePassword:!0,updatedAt:!0}});return!0===s.disabled&&await (0,w.V_)(a),await (0,p.b)({actorUserId:r.id,action:"user.update",targetUserId:a,metadata:s}),o.NextResponse.json(i)}catch(e){if(e instanceof u.G)return o.NextResponse.json({error:e.errors[0]?.message??"Invalid request"},{status:400});throw e}}async function x(e,{params:t}){let r;try{r=await (0,l.ZT)()}catch(e){return o.NextResponse.json({error:"Forbidden"},{status:e.statusCode??403})}let{id:a}=await t,s=await c.z.user.findUnique({where:{id:a}});if(!s)return o.NextResponse.json({error:"User not found"},{status:404});if(s.id===r.id)return o.NextResponse.json({error:"Cannot delete your own account"},{status:400});let n=await c.z.user.count({where:{role:"admin"}});return"admin"===s.role&&n<=1?o.NextResponse.json({error:"Cannot delete the last admin"},{status:400}):(await c.z.user.delete({where:{id:a}}),await (0,p.b)({actorUserId:r.id,action:"user.delete",targetUserId:a,metadata:{username:s.username}}),o.NextResponse.json({ok:!0}))}let f=new s.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/admin/users/[id]/route",pathname:"/api/admin/users/[id]",filename:"route",bundlePath:"app/api/admin/users/[id]/route"},resolvedPagePath:"C:\\Users\\mlodg\\Downloads\\HUD\\hud-webapp\\src\\app\\api\\admin\\users\\[id]\\route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:y,workUnitAsyncStorage:U,serverHooks:g}=f;function v(){return(0,i.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:U})}},6487:()=>{},8335:()=>{},6309:(e,t,r)=>{"use strict";r.d(t,{b:()=>s});var a=r(7914);async function s(e){await a.z.auditLog.create({data:{actorUserId:e.actorUserId,action:e.action,targetUserId:e.targetUserId??null,metadata:e.metadata??void 0}})}},7702:(e,t,r)=>{"use strict";r.d(t,{Hx:()=>o,ZT:()=>i,oC:()=>n});var a=r(6702),s=r(7914);async function n(){let e=await (0,a.Nx)();if(!e)throw new d("Unauthorized",401);let t=await s.z.user.findUnique({where:{id:e.userId}});if(!t||t.disabled)throw new d("Unauthorized",401);return{id:t.id,username:t.username,displayName:t.displayName,role:t.role,mustChangePassword:t.mustChangePassword}}async function i(){let e=await n();if("admin"!==e.role)throw new d("Forbidden",403);return e}async function o(){try{return await n()}catch{return null}}class d extends Error{constructor(e,t=401){super(e),this.statusCode=t,this.name="AuthError"}}},7914:(e,t,r)=>{"use strict";r.d(t,{z:()=>s});var a=r(6330);let s=globalThis.prisma??new a.PrismaClient},6702:(e,t,r)=>{"use strict";r.d(t,{$G:()=>c,C0:()=>p,Nx:()=>l,T$:()=>w,V_:()=>m,jw:()=>u});var a=r(4512),s=r(5511),n=r(7914),i=r(5378);let o="hud_session";function d(e){return(0,s.createHash)("sha256").update(e).digest("hex")}async function u(e){let t=(0,i.Ak)(32),r=d(t),a=new Date(Date.now()+6048e5);return await n.z.session.create({data:{userId:e,tokenHash:r,expiresAt:a}}),t}async function l(){let e=(await (0,a.UL)()).get(o);if(!e?.value)return null;let t=d(e.value),r=await n.z.session.findUnique({where:{tokenHash:t},include:{user:!0}});return!r||r.expiresAt<new Date||r.user.disabled?(r&&await n.z.session.delete({where:{id:r.id}}).catch(()=>{}),null):(await n.z.session.update({where:{id:r.id},data:{lastSeenAt:new Date}}),{userId:r.userId,sessionId:r.id})}async function c(e){(await (0,a.UL)()).set(o,e,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:604800,path:"/"})}async function p(){(await (0,a.UL)()).delete(o)}async function w(e){await n.z.session.delete({where:{id:e}}).catch(()=>{})}async function m(e){await n.z.session.deleteMany({where:{userId:e}})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[989,71,44,727],()=>r(3577));module.exports=a})();