(()=>{var e={};e.id=164,e.ids=[164],e.modules={6330:e=>{"use strict";e.exports=require("@prisma/client")},846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},2574:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>w,routeModule:()=>o,serverHooks:()=>c,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>m});var a={};r.r(a),r.d(a,{GET:()=>l});var n=r(2706),i=r(8203),s=r(5994),d=r(9187),u=r(6696);async function l(){await (0,u.fA)();let e=await (0,u.sb)();return e?d.NextResponse.json({activeStreamerUserId:e.activeStreamerUserId,isLive:e.isLive,liveStartedAt:e.liveStartedAt?.toISOString()??null,lastHeartbeatAt:e.lastHeartbeatAt?.toISOString()??null,updatedAt:e.updatedAt.toISOString()}):d.NextResponse.json({error:"Stream state not found"},{status:500})}let o=new n.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/stream/state/route",pathname:"/api/stream/state",filename:"route",bundlePath:"app/api/stream/state/route"},resolvedPagePath:"C:\\Users\\mlodg\\Downloads\\HUD\\hud-webapp\\src\\app\\api\\stream\\state\\route.ts",nextConfigOutput:"",userland:a}),{workAsyncStorage:p,workUnitAsyncStorage:m,serverHooks:c}=o;function w(){return(0,s.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:m})}},6487:()=>{},8335:()=>{},7914:(e,t,r)=>{"use strict";r.d(t,{z:()=>n});var a=r(6330);let n=globalThis.prisma??new a.PrismaClient},6696:(e,t,r)=>{"use strict";r.d(t,{Nx:()=>m,aX:()=>d,fA:()=>i,iE:()=>l,jB:()=>u,jN:()=>o,jQ:()=>p,kk:()=>w,sb:()=>s,vy:()=>c});var a=r(7914);function n(e){return{activeStreamerUserId:e.activeStreamerUserId,isLive:e.isLive,liveStartedAt:e.liveStartedAt,lastHeartbeatAt:e.lastHeartbeatAt,updatedAt:e.updatedAt}}async function i(){let e=await a.z.streamState.findUnique({where:{id:1}});return e?.lastHeartbeatAt&&e.activeStreamerUserId?Date.now()-e.lastHeartbeatAt.getTime()<1e4?{expired:!1,state:n(e)}:{expired:!0,state:n(await a.z.streamState.update({where:{id:1},data:{activeStreamerUserId:null,isLive:!1,liveStartedAt:null,lastHeartbeatAt:null,pendingRequestFromUserId:null,pendingRequestAt:null}}))}:{expired:!1,state:e?n(e):null}}async function s(){let e=await a.z.streamState.findUnique({where:{id:1}});return e?n(e):null}async function d(e){return n(await a.z.streamState.update({where:{id:1},data:{activeStreamerUserId:e,isLive:!1,liveStartedAt:null,lastHeartbeatAt:new Date,pendingRequestFromUserId:null,pendingRequestAt:null}}))}async function u(){return n(await a.z.streamState.update({where:{id:1},data:{activeStreamerUserId:null,isLive:!1,liveStartedAt:null,lastHeartbeatAt:null,pendingRequestFromUserId:null,pendingRequestAt:null}}))}async function l(e){return n(await a.z.streamState.update({where:{id:1},data:{activeStreamerUserId:e,isLive:!1,liveStartedAt:null,lastHeartbeatAt:new Date,pendingRequestFromUserId:null,pendingRequestAt:null}}))}async function o(e){return n(await a.z.streamState.update({where:{id:1},data:{isLive:e,...e&&{liveStartedAt:new Date},lastHeartbeatAt:new Date}}))}async function p(e){let t=await a.z.streamState.findUnique({where:{id:1}});return t&&t.activeStreamerUserId===e?(await a.z.streamState.update({where:{id:1},data:{lastHeartbeatAt:new Date}}),{ok:!0}):{ok:!1}}async function m(){let e=await a.z.streamState.findUnique({where:{id:1},select:{pendingRequestFromUserId:!0,pendingRequestAt:!0}});if(!e?.pendingRequestFromUserId||!e.pendingRequestAt)return null;let t=await a.z.user.findUnique({where:{id:e.pendingRequestFromUserId},select:{displayName:!0}});return{fromUserId:e.pendingRequestFromUserId,fromUsername:t?.displayName??"Unknown",at:e.pendingRequestAt}}async function c(e){let t=await a.z.streamState.findUnique({where:{id:1}});if(!t?.activeStreamerUserId)return{ok:!1,error:"No active streamer"};if(t.activeStreamerUserId===e)return{ok:!1,error:"You are the streamer"};if(t.pendingRequestFromUserId){if(t.pendingRequestFromUserId!==e)return{ok:!1,error:"Another request is pending"};if(Date.now()-(t.pendingRequestAt?.getTime()??0)<3e4)return{ok:!1,error:"Please wait before requesting again"}}return await a.z.streamState.update({where:{id:1},data:{pendingRequestFromUserId:e,pendingRequestAt:new Date}}),{ok:!0}}async function w(){await a.z.streamState.update({where:{id:1},data:{pendingRequestFromUserId:null,pendingRequestAt:null}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[989,71],()=>r(2574));module.exports=a})();