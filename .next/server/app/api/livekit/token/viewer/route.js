(()=>{var e={};e.id=963,e.ids=[963],e.modules={6330:e=>{"use strict";e.exports=require("@prisma/client")},846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},5511:e=>{"use strict";e.exports=require("crypto")},4573:e=>{"use strict";e.exports=require("node:buffer")},7598:e=>{"use strict";e.exports=require("node:crypto")},7975:e=>{"use strict";e.exports=require("node:util")},6504:(e,t,r)=>{"use strict";r.r(t),r.d(t,{patchFetch:()=>m,routeModule:()=>l,serverHooks:()=>h,workAsyncStorage:()=>p,workUnitAsyncStorage:()=>w});var s={};r.r(s),r.d(s,{POST:()=>c});var n=r(2706),i=r(8203),a=r(5994),o=r(9187),u=r(7702),d=r(5704);async function c(){try{let e=await (0,u.oC)(),t=process.env.LIVEKIT_URL,r=process.env.LIVEKIT_API_KEY,s=process.env.LIVEKIT_API_SECRET;if(!t||!r||!s)return o.NextResponse.json({error:"Streaming not configured"},{status:503});let n=new d.mk(r,s,{identity:e.id,name:e.displayName});n.addGrant({roomJoin:!0,room:"hud-room",canSubscribe:!0,canPublish:!1,canPublishData:!0});let i=await n.toJwt();return o.NextResponse.json({token:i,url:t})}catch(e){return o.NextResponse.json({error:"Unauthorized"},{status:e.statusCode??401})}}let l=new n.AppRouteRouteModule({definition:{kind:i.RouteKind.APP_ROUTE,page:"/api/livekit/token/viewer/route",pathname:"/api/livekit/token/viewer",filename:"route",bundlePath:"app/api/livekit/token/viewer/route"},resolvedPagePath:"C:\\Users\\mlodg\\Downloads\\HUD\\hud-webapp\\src\\app\\api\\livekit\\token\\viewer\\route.ts",nextConfigOutput:"",userland:s}),{workAsyncStorage:p,workUnitAsyncStorage:w,serverHooks:h}=l;function m(){return(0,a.patchFetch)({workAsyncStorage:p,workUnitAsyncStorage:w})}},6487:()=>{},8335:()=>{},7702:(e,t,r)=>{"use strict";r.d(t,{Hx:()=>o,ZT:()=>a,oC:()=>i});var s=r(6702),n=r(7914);async function i(){let e=await (0,s.Nx)();if(!e)throw new u("Unauthorized",401);let t=await n.z.user.findUnique({where:{id:e.userId}});if(!t||t.disabled)throw new u("Unauthorized",401);return{id:t.id,username:t.username,displayName:t.displayName,role:t.role,mustChangePassword:t.mustChangePassword}}async function a(){let e=await i();if("admin"!==e.role)throw new u("Forbidden",403);return e}async function o(){try{return await i()}catch{return null}}class u extends Error{constructor(e,t=401){super(e),this.statusCode=t,this.name="AuthError"}}},7914:(e,t,r)=>{"use strict";r.d(t,{z:()=>n});var s=r(6330);let n=globalThis.prisma??new s.PrismaClient},6702:(e,t,r)=>{"use strict";r.d(t,{$G:()=>l,C0:()=>p,Nx:()=>c,T$:()=>w,V_:()=>h,jw:()=>d});var s=r(4512),n=r(5511),i=r(7914),a=r(5378);let o="hud_session";function u(e){return(0,n.createHash)("sha256").update(e).digest("hex")}async function d(e){let t=(0,a.Ak)(32),r=u(t),s=new Date(Date.now()+6048e5);return await i.z.session.create({data:{userId:e,tokenHash:r,expiresAt:s}}),t}async function c(){let e=(await (0,s.UL)()).get(o);if(!e?.value)return null;let t=u(e.value),r=await i.z.session.findUnique({where:{tokenHash:t},include:{user:!0}});return!r||r.expiresAt<new Date||r.user.disabled?(r&&await i.z.session.delete({where:{id:r.id}}).catch(()=>{}),null):(await i.z.session.update({where:{id:r.id},data:{lastSeenAt:new Date}}),{userId:r.userId,sessionId:r.id})}async function l(e){(await (0,s.UL)()).set(o,e,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:604800,path:"/"})}async function p(){(await (0,s.UL)()).delete(o)}async function w(e){await i.z.session.delete({where:{id:e}}).catch(()=>{})}async function h(e){await i.z.session.deleteMany({where:{userId:e}})}}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[989,71,44,704],()=>r(6504));module.exports=s})();