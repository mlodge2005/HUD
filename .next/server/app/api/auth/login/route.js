(()=>{var e={};e.id=758,e.ids=[758],e.modules={6330:e=>{"use strict";e.exports=require("@prisma/client")},4329:e=>{"use strict";e.exports=require("argon2")},846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},5511:e=>{"use strict";e.exports=require("crypto")},7598:e=>{"use strict";e.exports=require("node:crypto")},3378:(e,t,s)=>{"use strict";s.r(t),s.d(t,{patchFetch:()=>y,routeModule:()=>x,serverHooks:()=>v,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>f});var r={};s.r(r),s.d(r,{POST:()=>h});var a=s(2706),n=s(8203),i=s(5994),u=s(9187),o=s(7727),d=s(5665),p=s(4329),l=s(7914),c=s(6702),w=s(8122);let m=o.Ik({username:o.Yj().min(1),password:o.Yj().min(1)});async function h(e){try{let t=await e.json(),{username:s,password:r}=m.parse(t),a=await l.z.user.findUnique({where:{username:s}});if(!a)return await (0,w.Q)({usernameAttempted:s,eventType:"login_failed"}),u.NextResponse.json({error:"Invalid username or password"},{status:401});if(a.disabled)return await (0,w.Q)({usernameAttempted:s,eventType:"login_failed"}),u.NextResponse.json({error:"Account is disabled"},{status:403});if(!await p.verify(a.passwordHash,r))return await (0,w.Q)({usernameAttempted:s,eventType:"login_failed"}),u.NextResponse.json({error:"Invalid username or password"},{status:401});let n=await (0,c.jw)(a.id);return await (0,c.$G)(n),await (0,w.Q)({userId:a.id,usernameAttempted:s,eventType:"login_success"}),u.NextResponse.json({user:{id:a.id,username:a.username,displayName:a.displayName,role:a.role,mustChangePassword:a.mustChangePassword}})}catch(e){if(e instanceof d.G)return u.NextResponse.json({error:"Invalid request body"},{status:400});throw e}}let x=new a.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:"app/api/auth/login/route"},resolvedPagePath:"C:\\Users\\mlodg\\Downloads\\HUD\\hud-webapp\\src\\app\\api\\auth\\login\\route.ts",nextConfigOutput:"",userland:r}),{workAsyncStorage:g,workUnitAsyncStorage:f,serverHooks:v}=x;function y(){return(0,i.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:f})}},6487:()=>{},8335:()=>{},8122:(e,t,s)=>{"use strict";s.d(t,{Q:()=>n});var r=s(7914),a=s(4512);async function n(e){let t=await (0,a.b3)(),s=e.ip??t.get("x-forwarded-for")??t.get("x-real-ip")??null,n=e.userAgent??t.get("user-agent")??null;await r.z.authEvent.create({data:{userId:e.userId??null,usernameAttempted:e.usernameAttempted??null,eventType:e.eventType,ip:s,userAgent:n}})}},7914:(e,t,s)=>{"use strict";s.d(t,{z:()=>a});var r=s(6330);let a=globalThis.prisma??new r.PrismaClient},6702:(e,t,s)=>{"use strict";s.d(t,{$G:()=>l,C0:()=>c,Nx:()=>p,T$:()=>w,V_:()=>m,jw:()=>d});var r=s(4512),a=s(5511),n=s(7914),i=s(5378);let u="hud_session";function o(e){return(0,a.createHash)("sha256").update(e).digest("hex")}async function d(e){let t=(0,i.Ak)(32),s=o(t),r=new Date(Date.now()+6048e5);return await n.z.session.create({data:{userId:e,tokenHash:s,expiresAt:r}}),t}async function p(){let e=(await (0,r.UL)()).get(u);if(!e?.value)return null;let t=o(e.value),s=await n.z.session.findUnique({where:{tokenHash:t},include:{user:!0}});return!s||s.expiresAt<new Date||s.user.disabled?(s&&await n.z.session.delete({where:{id:s.id}}).catch(()=>{}),null):(await n.z.session.update({where:{id:s.id},data:{lastSeenAt:new Date}}),{userId:s.userId,sessionId:s.id})}async function l(e){(await (0,r.UL)()).set(u,e,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:604800,path:"/"})}async function c(){(await (0,r.UL)()).delete(u)}async function w(e){await n.z.session.delete({where:{id:e}}).catch(()=>{})}async function m(e){await n.z.session.deleteMany({where:{userId:e}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[989,71,44,727],()=>s(3378));module.exports=r})();