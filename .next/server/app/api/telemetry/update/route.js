(()=>{var e={};e.id=293,e.ids=[293],e.modules={6330:e=>{"use strict";e.exports=require("@prisma/client")},846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},4870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},9294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},3033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},5511:e=>{"use strict";e.exports=require("crypto")},7598:e=>{"use strict";e.exports=require("node:crypto")},1465:(e,t,a)=>{"use strict";a.r(t),a.d(t,{patchFetch:()=>y,routeModule:()=>h,serverHooks:()=>v,workAsyncStorage:()=>g,workUnitAsyncStorage:()=>f});var r={};a.r(r),a.d(r,{POST:()=>m});var n=a(2706),s=a(8203),i=a(5994),u=a(9187),d=a(7727),o=a(5665),l=a(7702),c=a(6696),p=a(7914);let w=d.Ik({lat:d.ai(),lon:d.ai(),headingDeg:d.ai().optional(),accuracyM:d.ai().optional()});async function m(e){try{let t=await (0,l.oC)(),a=await (0,c.sb)();if(!a||a.activeStreamerUserId!==t.id)return u.NextResponse.json({error:"Only the active streamer can send telemetry"},{status:403});let r=await e.json(),n=w.parse(r);return await p.z.telemetryLatest.upsert({where:{streamStateId:1},create:{streamStateId:1,lat:n.lat,lon:n.lon,headingDeg:n.headingDeg??null,accuracyM:n.accuracyM??null},update:{lat:n.lat,lon:n.lon,headingDeg:n.headingDeg??void 0,accuracyM:n.accuracyM??void 0}}),u.NextResponse.json({ok:!0})}catch(e){if(e instanceof o.G)return u.NextResponse.json({error:e.errors[0]?.message??"Invalid request"},{status:400});return u.NextResponse.json({error:"Unauthorized"},{status:e.statusCode??401})}}let h=new n.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/telemetry/update/route",pathname:"/api/telemetry/update",filename:"route",bundlePath:"app/api/telemetry/update/route"},resolvedPagePath:"C:\\Users\\mlodg\\Downloads\\HUD\\hud-webapp\\src\\app\\api\\telemetry\\update\\route.ts",nextConfigOutput:"",userland:r}),{workAsyncStorage:g,workUnitAsyncStorage:f,serverHooks:v}=h;function y(){return(0,i.patchFetch)({workAsyncStorage:g,workUnitAsyncStorage:f})}},6487:()=>{},8335:()=>{},7702:(e,t,a)=>{"use strict";a.d(t,{Hx:()=>u,ZT:()=>i,oC:()=>s});var r=a(6702),n=a(7914);async function s(){let e=await (0,r.Nx)();if(!e)throw new d("Unauthorized",401);let t=await n.z.user.findUnique({where:{id:e.userId}});if(!t||t.disabled)throw new d("Unauthorized",401);return{id:t.id,username:t.username,displayName:t.displayName,role:t.role,mustChangePassword:t.mustChangePassword}}async function i(){let e=await s();if("admin"!==e.role)throw new d("Forbidden",403);return e}async function u(){try{return await s()}catch{return null}}class d extends Error{constructor(e,t=401){super(e),this.statusCode=t,this.name="AuthError"}}},7914:(e,t,a)=>{"use strict";a.d(t,{z:()=>n});var r=a(6330);let n=globalThis.prisma??new r.PrismaClient},6702:(e,t,a)=>{"use strict";a.d(t,{$G:()=>c,C0:()=>p,Nx:()=>l,T$:()=>w,V_:()=>m,jw:()=>o});var r=a(4512),n=a(5511),s=a(7914),i=a(5378);let u="hud_session";function d(e){return(0,n.createHash)("sha256").update(e).digest("hex")}async function o(e){let t=(0,i.Ak)(32),a=d(t),r=new Date(Date.now()+6048e5);return await s.z.session.create({data:{userId:e,tokenHash:a,expiresAt:r}}),t}async function l(){let e=(await (0,r.UL)()).get(u);if(!e?.value)return null;let t=d(e.value),a=await s.z.session.findUnique({where:{tokenHash:t},include:{user:!0}});return!a||a.expiresAt<new Date||a.user.disabled?(a&&await s.z.session.delete({where:{id:a.id}}).catch(()=>{}),null):(await s.z.session.update({where:{id:a.id},data:{lastSeenAt:new Date}}),{userId:a.userId,sessionId:a.id})}async function c(e){(await (0,r.UL)()).set(u,e,{httpOnly:!0,secure:!0,sameSite:"lax",maxAge:604800,path:"/"})}async function p(){(await (0,r.UL)()).delete(u)}async function w(e){await s.z.session.delete({where:{id:e}}).catch(()=>{})}async function m(e){await s.z.session.deleteMany({where:{userId:e}})}},6696:(e,t,a)=>{"use strict";a.d(t,{Nx:()=>p,aX:()=>u,fA:()=>s,iE:()=>o,jB:()=>d,jN:()=>l,jQ:()=>c,kk:()=>m,sb:()=>i,vy:()=>w});var r=a(7914);function n(e){return{activeStreamerUserId:e.activeStreamerUserId,isLive:e.isLive,liveStartedAt:e.liveStartedAt,lastHeartbeatAt:e.lastHeartbeatAt,updatedAt:e.updatedAt}}async function s(){let e=await r.z.streamState.findUnique({where:{id:1}});return e?.lastHeartbeatAt&&e.activeStreamerUserId?Date.now()-e.lastHeartbeatAt.getTime()<1e4?{expired:!1,state:n(e)}:{expired:!0,state:n(await r.z.streamState.update({where:{id:1},data:{activeStreamerUserId:null,isLive:!1,liveStartedAt:null,lastHeartbeatAt:null,pendingRequestFromUserId:null,pendingRequestAt:null}}))}:{expired:!1,state:e?n(e):null}}async function i(){let e=await r.z.streamState.findUnique({where:{id:1}});return e?n(e):null}async function u(e){return n(await r.z.streamState.update({where:{id:1},data:{activeStreamerUserId:e,isLive:!1,liveStartedAt:null,lastHeartbeatAt:new Date,pendingRequestFromUserId:null,pendingRequestAt:null}}))}async function d(){return n(await r.z.streamState.update({where:{id:1},data:{activeStreamerUserId:null,isLive:!1,liveStartedAt:null,lastHeartbeatAt:null,pendingRequestFromUserId:null,pendingRequestAt:null}}))}async function o(e){return n(await r.z.streamState.update({where:{id:1},data:{activeStreamerUserId:e,isLive:!1,liveStartedAt:null,lastHeartbeatAt:new Date,pendingRequestFromUserId:null,pendingRequestAt:null}}))}async function l(e){return n(await r.z.streamState.update({where:{id:1},data:{isLive:e,...e&&{liveStartedAt:new Date},lastHeartbeatAt:new Date}}))}async function c(e){let t=await r.z.streamState.findUnique({where:{id:1}});return t&&t.activeStreamerUserId===e?(await r.z.streamState.update({where:{id:1},data:{lastHeartbeatAt:new Date}}),{ok:!0}):{ok:!1}}async function p(){let e=await r.z.streamState.findUnique({where:{id:1},select:{pendingRequestFromUserId:!0,pendingRequestAt:!0}});if(!e?.pendingRequestFromUserId||!e.pendingRequestAt)return null;let t=await r.z.user.findUnique({where:{id:e.pendingRequestFromUserId},select:{displayName:!0}});return{fromUserId:e.pendingRequestFromUserId,fromUsername:t?.displayName??"Unknown",at:e.pendingRequestAt}}async function w(e){let t=await r.z.streamState.findUnique({where:{id:1}});if(!t?.activeStreamerUserId)return{ok:!1,error:"No active streamer"};if(t.activeStreamerUserId===e)return{ok:!1,error:"You are the streamer"};if(t.pendingRequestFromUserId){if(t.pendingRequestFromUserId!==e)return{ok:!1,error:"Another request is pending"};if(Date.now()-(t.pendingRequestAt?.getTime()??0)<3e4)return{ok:!1,error:"Please wait before requesting again"}}return await r.z.streamState.update({where:{id:1},data:{pendingRequestFromUserId:e,pendingRequestAt:new Date}}),{ok:!0}}async function m(){await r.z.streamState.update({where:{id:1},data:{pendingRequestFromUserId:null,pendingRequestAt:null}})}}};var t=require("../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[989,71,44,727],()=>a(1465));module.exports=r})();